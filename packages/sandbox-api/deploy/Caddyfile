# toolkata Sandbox API - Caddy reverse proxy configuration
#
# Install instructions:
# 1. Install Caddy: https://caddyserver.com/docs/install
# 2. Copy this file to /etc/caddy/Caddyfile
# 3. Test config: sudo caddy validate --config /etc/caddy/Caddyfile
# 4. Reload: sudo systemctl reload caddy
#
# Caddy automatically:
# - Obtains and renews TLS certificates from Let's Encrypt
# - Terminates HTTPS/WSS connections
# - Handles HTTP/2 and WebSocket upgrades
#
# Admin route security:
# - /admin/* routes are protected by IP allowlist (Vercel egress IPs)
# - Application also validates X-Admin-Key header (defense in depth)
# - Vercel egress IPs: https://vercel.com/docs/ips

# Global options
{
	# Email for Let's Encrypt notifications
	email admin@toolkata.com

	# ACME endpoint (use staging for testing, prod for live)
	# acme https://acme-staging-v02.api.letsencrypt.org/directory
	acme https://acme-v02.api.letsencrypt.org/directory

	# Default SNI (Server Name Indication) for connections
	default_sns sandbox.toolkata.com
}

# Sandbox API site
sandbox.toolkata.com {
	# Logging
	log {
		output file /var/log/caddy/sandbox-api.log {
			roll_size 100mb
			roll_keep 5
		}
		format json
		level info
	}

	# CORS headers for frontend origin
	header {
		# Allow frontend origin (adjust for production)
		Access-Control-Allow-Origin https://toolkata.com
		Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
		Access-Control-Max-Age "3600"
		# Allow WebSocket upgrade headers
		Access-Control-Expose-Headers "Upgrade, Connection"

		# Security headers
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"

		# Remove server header
		-Server
	}

	# Health check endpoint (no auth required)
	handle /health {
		reverse_proxy localhost:3001
	}

	# Admin endpoints - protected by IP allowlist + X-Admin-Key header
	# Only allow requests from Vercel egress IPs (https://vercel.com/docs/ips)
	handle /admin* {
		# IP allowlist - Vercel egress IPs (update regularly)
		# Get current list from: https://vercel.com/docs/ips
		# Format: ip4 ranges, ip6 ranges
		remote_ip 76.76.21.0/24 76.76.19.0/24 {
			# Reject requests not from Vercel
			respond "Forbidden" 403
		}

		reverse_proxy localhost:3001 {
			# Forward real client IP (the Vercel server IP)
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# Timeouts for admin operations
			transport http {
				dial_timeout 5s
				response_header_timeout 30s
				read_timeout 30s
				write_timeout 30s
			}
		}
	}

	# Session management endpoints
	handle /sessions* {
		reverse_proxy localhost:3001 {
			# WebSocket upgrade support
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}

			# Forward real client IP
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# Timeouts for long-running sessions
			transport http {
				dial_timeout 5s
				response_header_timeout 60s
				# Keep connections alive for WebSocket
				read_timeout 0
				write_timeout 0
			}
		}
	}

	# WebSocket endpoint for terminal I/O
	handle /sessions/*/ws {
		reverse_proxy localhost:3001 {
			# WebSocket upgrade (explicit)
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}

			# Forward real client IP
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# Transport settings for long-lived WebSocket connections
			transport http {
				dial_timeout 5s
				response_header_timeout 60s
				# No read/write timeout for persistent connections
				read_timeout 0
				write_timeout 0
				# Keepalive
			 keepalive 30s
				keepalive_idle_conns 2
			}

			# Buffering: disable for WebSocket
			flush_interval -1
		}
	}

	# OPTIONS for CORS preflight
	handle_options {
		reverse_proxy localhost:3001 {
			header_up Access-Control-Allow-Origin https://toolkata.com
			header_up Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS"
			header_up Access-Control-Allow-Headers "Content-Type, Authorization"
			header_up Access-Control-Max-Age "3600"
		}
	}

	# Fallback: proxy all other requests
	handle {
		reverse_proxy localhost:3001 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
}

# HTTP to HTTPS redirect
http://sandbox.toolkata.com {
	redir https://sandbox.toolkata.com{uri} permanent
}
