# toolkata Sandbox API - Caddy reverse proxy configuration
#
# Install instructions:
# 1. Install Caddy: https://caddyserver.com/docs/install
# 2. Copy this file to /etc/caddy/Caddyfile
# 3. Test config: sudo caddy validate --config /etc/caddy/Caddyfile
# 4. Reload: sudo systemctl reload caddy
#
# Caddy automatically:
# - Obtains and renews TLS certificates from Let's Encrypt
# - Terminates HTTPS/WSS connections
# - Handles HTTP/2 and WebSocket upgrades

# Global options
{
	# Email for Let's Encrypt notifications
	email admin@toolkata.dev

	# ACME endpoint (use staging for testing, prod for live)
	# acme https://acme-staging-v02.api.letsencrypt.org/directory
	acme https://acme-v02.api.letsencrypt.org/directory

	# Default SNI (Server Name Indication) for connections
	default_sns sandbox.toolkata.dev
}

# Sandbox API site
sandbox.toolkata.dev {
	# Logging
	log {
		output file /var/log/caddy/sandbox-api.log {
			roll_size 100mb
			roll_keep 5
		}
		format json
		level info
	}

	# CORS headers for frontend origin
	header {
		# Allow frontend origin (adjust for production)
		Access-Control-Allow-Origin https://toolkata.dev
		Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS"
		Access-Control-Allow-Headers "Content-Type, Authorization"
		Access-Control-Max-Age "3600"
		# Allow WebSocket upgrade headers
		Access-Control-Expose-Headers "Upgrade, Connection"

		# Security headers
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"

		# Remove server header
		-Server
	}

	# Health check endpoint (no auth required)
	handle /health {
		reverse_proxy localhost:3001
	}

	# Session management endpoints
	handle /sessions* {
		reverse_proxy localhost:3001 {
			# WebSocket upgrade support
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}

			# Forward real client IP
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# Timeouts for long-running sessions
			transport http {
				dial_timeout 5s
				response_header_timeout 60s
				# Keep connections alive for WebSocket
				read_timeout 0
				write_timeout 0
			}
		}
	}

	# WebSocket endpoint for terminal I/O
	handle /sessions/*/ws {
		reverse_proxy localhost:3001 {
			# WebSocket upgrade (explicit)
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}

			# Forward real client IP
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}

			# Transport settings for long-lived WebSocket connections
			transport http {
				dial_timeout 5s
				response_header_timeout 60s
				# No read/write timeout for persistent connections
				read_timeout 0
				write_timeout 0
				# Keepalive
			 keepalive 30s
				keepalive_idle_conns 2
			}

			# Buffering: disable for WebSocket
			flush_interval -1
		}
	}

	# OPTIONS for CORS preflight
	handle_options {
		reverse_proxy localhost:3001 {
			header_up Access-Control-Allow-Origin https://toolkata.dev
			header_up Access-Control-Allow-Methods "GET, POST, DELETE, OPTIONS"
			header_up Access-Control-Allow-Headers "Content-Type, Authorization"
			header_up Access-Control-Max-Age "3600"
		}
	}

	# Fallback: proxy all other requests
	handle {
		reverse_proxy localhost:3001 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}
}

# HTTP to HTTPS redirect
http://sandbox.toolkata.dev {
	redir https://sandbox.toolkata.dev{uri} permanent
}
